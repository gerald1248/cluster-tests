for namespace in ${USER_NAMESPACES}; do
  for pod in `kubectl get pods --field-selector=status.phase=Running -n ${namespace} 2>/dev/null | cut -d' ' -f1 | tail -n +2`; do
    count_privileged=`kubectl get po/${pod} -n ${namespace} -o json 2>/dev/null | jq -r '..|.securityContext?.privileged' | grep -c true`
    if [ "${count_privileged}" -ne "0" ]; then
      echo "pod ${pod} in namespace ${namespace} runs with privileged security context"
      exit 1
  done
done
